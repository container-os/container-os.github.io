#!/usr/bin/env python
import os
import subprocess
import requests
import re
import yaml


def load_md_meta(raw_data):
    data = raw_data.split("---", 2)
    if len(data) == 3 and data[0] == "":
        return yaml.load(data[1]), data[2]
    return None, raw_data


for (dirpath, dirnames, filenames) in os.walk('content'):
    for filename in filenames:
        if filename[-3:] != ".md":
            continue
        filename = os.path.join(dirpath, filename)
        print("checking file: {}".format(filename))
        with open(filename, "r") as f:
            (meta, old_raw) = load_md_meta(f.read())
        if meta == None or 'raw' not in meta:
            continue

        print("loading data from: {}".format(meta['raw']))
        conn = requests.get(meta['raw'])
        (_, raw) = load_md_meta(conn.content)

        print("updating file: {}".format(filename))

        meta['zzzNote'] = "do not edit the file directly,\
 edit the raw data instead of it"
        with open(filename, "w") as f:
            yaml_meta = yaml.dump(meta, default_flow_style=False)
            # remove comments
            # |> [shawn]
            raw = re.sub(r'\n>\s\[.*\].*\n', '', raw, flags=re.IGNORECASE)
            f.write("---\n{}---\n{}".format(yaml_meta, raw))
